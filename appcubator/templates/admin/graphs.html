{% extends "admin/admin-base.html" %}

{% block css %}
<style type="text/css">
.chart svg {
  height: 400px;
}
</style>
{% endblock %}

{% block content %}
  <h2>Graphs</h2>
  <hr>

  <h3>Active Users</h3>
  <div id="active-users" class="chart">
    <svg></svg>
  </div>

  <h3>User Signups</h3>
  <div id="user-signups" class="chart">
    <svg></svg>
  </div>

{% endblock %}

{% block js %}
<script type="text/javascript">
  $.getJSON("{% url appcubator.admin_views.active_users_json beginning now 'day' %}", {}, function(data) {
    //data = JSON.parse('{"07/13/13": 122, "07/25/13": 13, "07/23/13": 13, "07/21/13": 5, "07/15/13": 28, "07/18/13": 13, "07/22/13": 15, "07/16/13": 19, "07/24/13": 23, "07/20/13": 10, "07/19/13": 11, "07/14/13": 57, "07/17/13": 14}');
    nv.addGraph(function() {
      var chart = nv.models.multiBarChart()
          .x(function(d) { return d.label.toLocaleDateString() })
          .y(function(d) { return d.value })
          .staggerLabels(true)
          .tooltips(true);

      chart.reduceXTicks(true);

      chart.xAxis.tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

      d3.select('#active-users svg')
          .datum(parseActiveUsersData(data))
        .transition().duration(500)
          .call(chart);

      nv.utils.windowResize(chart.update);

      return chart;
    });
  });

  function parseActiveUsersData(data) {
    var values = [];
    for(key in data) {
      values.push({
        'label': new Date(key),
        'value': data[key]
      });
    }
    values.sort(function(v1, v2) {
      return (v1.label <= v2.label) ? -1 : 1;
    });
    return [{
      "key": "Active Users",
      "values": values
    }];
  }

  /*
   * User signups chart
   */
  $.getJSON("{% url appcubator.admin_views.user_signups_json %}", {}, function(data) {
    //data = [{'day_joined': '2013-06-26', 'num_users': 2},{'day_joined': '2013-06-27', 'num_users': 2},{'day_joined': '2013-07-03', 'num_users': 2},{'day_joined': '2013-07-04', 'num_users': 5},{'day_joined': '2013-07-05', 'num_users': 1},{'day_joined': '2013-07-07', 'num_users': 1},{'day_joined': '2013-07-08', 'num_users': 1},{'day_joined': '2013-07-09', 'num_users': 2},{'day_joined': '2013-07-10', 'num_users': 1},{'day_joined': '2013-07-11', 'num_users': 2},{'day_joined': '2013-07-13', 'num_users': 57},{'day_joined': '2013-07-14', 'num_users': 103},{'day_joined': '2013-07-15', 'num_users': 20},{'day_joined': '2013-07-16', 'num_users': 8},{'day_joined': '2013-07-17', 'num_users': 3},{'day_joined': '2013-07-18', 'num_users': 1},{'day_joined': '2013-07-19', 'num_users': 3},{'day_joined': '2013-07-20', 'num_users': 1},{'day_joined': '2013-07-22', 'num_users': 4},{'day_joined': '2013-07-23', 'num_users': 3},{'day_joined': '2013-07-24', 'num_users': 10},{'day_joined': '2013-07-25', 'num_users': 2},{'day_joined': '2013-07-26', 'num_users': 3},{'day_joined': '2013-07-27', 'num_users': 1},{'day_joined': '2013-07-28', 'num_users': 2},{'day_joined': '2013-07-29', 'num_users': 5},{'day_joined': '2013-07-30', 'num_users': 5}];
    nv.addGraph(function() {
      var chart = nv.models.multiBarChart()
          .x(function(d) { return d.label.toLocaleDateString() })
          .y(function(d) { return d.value })

      chart.xAxis.tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

      d3.select('#user-signups svg')
          .datum(parseUserSignupsData(data))
        .transition().duration(500)
          .call(chart);

      nv.utils.windowResize(chart.update);

      return chart;
    });
  });

  function parseUserSignupsData(data) {
    var values = [];
    _(data).each(function(d) {
      values.push({
        'label': new Date(d['day_joined']),
        'value': d['num_users']
      })
    });

    values.sort(function(v1, v2) {
      return (v1.label <= v2.label) ? -1 : 1;
    });
    return [{
      "key": "User Signups",
      "values": values
    }];
  }
</script>
{% endblock %}
